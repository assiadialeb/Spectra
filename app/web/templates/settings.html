{% extends "base.html" %}
{% set active_page = "settings" %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <h1 class="h2 mb-4">Settings</h1>

        <form method="POST" action="{{ url_for('web.settings') }}">
            <div class="card mb-4">
                <div class="card-header">
                    <i class="bi bi-building me-2"></i> General Configuration
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="company_name" class="form-label">Company Name</label>
                        <input type="text" class="form-control" id="company_name" name="company_name"
                            value="{{ settings.company_name if settings.company_name else 'Spectra' }}">
                        <div class="form-text">Displayed in generated reports (e.g. "Acme Corp Security").</div>
                    </div>
                    <div class="mb-3">
                        <label for="language" class="form-label">Default Language</label>
                        <select class="form-select" id="language" name="language">
                            <option value="fr" {% if settings.language=='fr' %}selected{% endif %}>Fran√ßais</option>
                            <option value="en" {% if settings.language=='en' %}selected{% endif %}>English</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-header">
                    <i class="bi bi-github me-2"></i> GitHub Configuration
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="github_pat" class="form-label">Personal Access Token (PAT)</label>
                        <input type="password" class="form-control" id="github_pat" name="github_pat"
                            value="{{ settings.github_pat if settings.github_pat else '' }}"
                            placeholder="ghp_xxxxxxxxxxxxxxxxxxxx">
                        <div class="form-text">Used to clone private repositories. Stored locally.</div>
                    </div>
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-header">
                    <i class="bi bi-robot me-2"></i> AI Configuration
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="ai_provider" class="form-label">AI Provider</label>
                        <select class="form-select" id="ai_provider" name="ai_provider"
                            onchange="updateProviderFields()">
                            <option value="gemini" {% if settings.ai_provider=='gemini' %}selected{% endif %}>Google
                                Gemini</option>
                            <option value="openai" {% if settings.ai_provider=='openai' %}selected{% endif %}>OpenAI
                            </option>
                            <option value="openrouter" {% if settings.ai_provider=='openrouter' %}selected{% endif %}>
                                OpenRouter</option>
                            <option value="ollama" {% if settings.ai_provider=='ollama' %}selected{% endif %}>Ollama
                                (Local)
                            </option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="ai_api_key" class="form-label">API Key</label>
                        <input type="password" class="form-control" id="ai_api_key" name="ai_api_key"
                            value="{{ settings.ai_api_key if settings.ai_api_key else '' }}">
                    </div>

                    <div class="mb-3">
                        <label for="ai_model" class="form-label">Model</label>
                        <input type="text" class="form-control" id="ai_model" name="ai_model"
                            value="{{ settings.ai_model if settings.ai_model else 'gemini-pro' }}">
                        <div class="form-text">e.g., gemini-1.5-pro, gpt-4, mistral</div>
                    </div>

                    <div class="mb-3" id="url-field">
                        <label for="ai_api_url" class="form-label">API URL (Optional)</label>
                        <input type="text" class="form-control" id="ai_api_url" name="ai_api_url"
                            value="{{ settings.ai_api_url if settings.ai_api_url else '' }}"
                            placeholder="https://api.openai.com/v1">
                        <div class="form-text">Required for Ollama or custom endpoints.</div>
                    </div>

                    <div class="d-flex justify-content-end">
                        <button type="submit" class="btn btn-primary">Save Settings</button>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
    function updateProviderFields() {
        const provider = document.getElementById('ai_provider').value;
        const modelInput = document.getElementById('ai_model');
        const urlInput = document.getElementById('ai_api_url');

        // Defaults helpers
        if (provider === 'gemini') {
            if (!modelInput.value) modelInput.value = 'gemini-1.5-pro';
        } else if (provider === 'openai') {
            if (!modelInput.value) modelInput.value = 'gpt-4-turbo';
        } else if (provider === 'ollama') {
            if (!urlInput.value) urlInput.value = 'http://localhost:11434/v1';
        }
    }
</script>
{% endblock %}