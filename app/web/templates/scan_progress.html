{% extends "base.html" %}

{% block content %}
<div class="container py-5 text-center">
    <div class="card p-5 mx-auto" style="max-width: 600px;">
        <div class="card-body">
            <h2 class="mb-4">Scan in Progress</h2>

            <div id="progress-spinner" class="my-5">
                <div class="spinner-border text-primary" role="status" style="width: 4rem; height: 4rem;">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3 text-muted">Running analysis engines...</p>
            </div>

            <div id="success-message" class="d-none">
                <i class="bi bi-check-circle-fill text-success display-1 mb-3"></i>
                <h3>Scan Complete!</h3>
                <p class="text-muted">Analysis finished successfully.</p>
                <a href="{{ url_for('web.scan_report', scan_id=scan.id) }}" class="btn btn-primary btn-lg mt-3">View
                    Report</a>
            </div>

            <div id="error-message" class="d-none">
                <i class="bi bi-x-circle-fill text-danger display-1 mb-3"></i>
                <h3>Scan Failed</h3>
                <p class="text-muted">An error occurred during execution.</p>
                <a href="{{ url_for('web.project_detail', project_id=project.id) }}"
                    class="btn btn-outline-secondary mt-3">Back to Project</a>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Trigger the scan execution
        fetch("{{ url_for('web.execute_scan', scan_id=scan.id) }}")
            .then(response => {
                if (response.ok) {
                    document.getElementById('progress-spinner').classList.add('d-none');
                    document.getElementById('success-message').classList.remove('d-none');
                    // Optional: Auto redirect
                    // window.location.href = "{{ url_for('web.scan_report', scan_id=scan.id) }}";
                } else {
                    throw new Error('Scan failed');
                }
            })
            .catch(error => {
                document.getElementById('progress-spinner').classList.add('d-none');
                document.getElementById('error-message').classList.remove('d-none');
            });
    });
</script>
{% endblock %}