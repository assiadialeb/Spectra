{% extends "base.html" %}

{% block content %}
<div class="container py-5 text-center">
    <div class="card p-5 mx-auto" style="max-width: 600px;">
        <div class="card-body">
            <h2 class="mb-4">Scan in Progress</h2>

            <div id="progress-spinner" class="my-5">
                <div class="spinner-border text-primary" role="status" style="width: 4rem; height: 4rem;">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3 text-muted">Running analysis engines...</p>
            </div>

            <div id="success-message" class="d-none">
                <i class="bi bi-check-circle-fill text-success display-1 mb-3"></i>
                <h3>Scan Complete!</h3>
                <p class="text-muted">Analysis finished successfully.</p>
                <a href="{{ url_for('web.scan_report', scan_id=scan.id) }}" class="btn btn-primary btn-lg mt-3">View
                    Report</a>
            </div>

            <div id="error-message" class="d-none">
                <i class="bi bi-x-circle-fill text-danger display-1 mb-3"></i>
                <h3>Scan Failed</h3>
                <p class="text-muted">An error occurred during execution.</p>
                <a href="{{ url_for('web.project_detail', project_id=project.id) }}"
                    class="btn btn-outline-secondary mt-3">Back to Project</a>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // 1. Trigger the scan execution (non-blocking)
        fetch("{{ url_for('web.execute_scan', scan_id=scan.id) }}")
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to start scan');
                }
                console.log("Scan started...");
                // 2. Start Polling for Status
                startPolling();
            })
            .catch(error => {
                showError();
            });

        function startPolling() {
            const pollInterval = setInterval(() => {
                fetch("{{ url_for('web.check_scan_status', scan_id=scan.id) }}")
                    .then(response => response.json())
                    .then(data => {
                        console.log("Scan Status:", data.status);

                        if (data.status === 'COMPLETED') {
                            clearInterval(pollInterval);
                            showSuccess();
                        } else if (data.status === 'FAILED') {
                            clearInterval(pollInterval);
                            showError();
                        }
                        // If RUNNING or PENDING, do nothing and wait for next poll
                    })
                    .catch(err => {
                        console.error("Polling error:", err);
                        // Don't stop polling on transient network errors, maybe?
                    });
            }, 2000); // Check every 2 seconds
        }

        function showSuccess() {
            document.getElementById('progress-spinner').classList.add('d-none');
            document.getElementById('success-message').classList.remove('d-none');
            // Auto redirect after a short delay
            setTimeout(() => {
                window.location.href = "{{ url_for('web.scan_report', scan_id=scan.id) }}";
            }, 1000);
        }

        function showError() {
            document.getElementById('progress-spinner').classList.add('d-none');
            document.getElementById('error-message').classList.remove('d-none');
        }
    });
</script>
{% endblock %}